// Certutil LOLBAS Abuse Detection
// Detects malicious use of certutil.exe for file downloads, encoding, and reconnaissance

// Parameters
let DetectionWindow = 1d;
let BaselineWindow = 30d;
let CertutilBinary = "certutil.exe";

// High-risk certutil operations (common in attacks)
let MaliciousFlags = dynamic([
    "-urlcache",     // Download files from URL
    "-f",            // Force overwrite (often with -urlcache)
    "-split",        // Split file (data staging)
    "-encode",       // Encode file (obfuscation)
    "-decode",       // Decode file (deobfuscation)
    "-ping",         // Network connectivity check
    "-verifyctl",    // Can be used for downloads
    "-syncwithwu"    // Windows Update sync abuse
]);

// Additional suspicious patterns
let SuspiciousPatterns = dynamic([
    "http://", "https://", "ftp://",  // Network URLs
    ".txt", ".ps1", ".exe", ".dll", ".bat", ".vbs", ".js",  // Common payload extensions
    "admin$", "c$", "ipc$",  // SMB shares
    "\\\\", "127.0.0.1", "localhost"  // Network paths
]);

// Suspicious execution paths
let SuspiciousPaths = dynamic([
    "\\temp\\", "\\tmp\\",
    "\\appdata\\local\\temp\\", "\\appdata\\roaming\\",
    "\\programdata\\", "\\public\\", "\\users\\public\\",
    "\\downloads\\", "\\desktop\\",
    "\\perflogs\\", "\\recycler\\", "\\recycle.bin\\",
    "\\inetpub\\wwwroot\\", "\\inetpub\\temp\\"
]);

// Legitimate certutil usage patterns (certificate management)
let LegitimateOperations = dynamic([
    "-addstore", "-delstore", "-viewstore",  // Certificate store operations
    "-enterprise", "-user", "-grouppolicy",  // Certificate policy
    "-installcert", "-deletecert",           // Certificate installation
    "-crl", "-verify"                        // Certificate verification
]);

// Get baseline of certutil usage (ALL usage, not just legitimate)
let CertutilBaseline = DeviceProcessEvents
| where TimeGenerated between (ago(BaselineWindow) .. ago(DetectionWindow))
| where FileName =~ CertutilBinary
| extend ExecPathNormalized = tolower(FolderPath)
| summarize 
    BaselineExecutions = count(),
    KnownPaths = make_set(tolower(FolderPath)),
    CommandPatterns = make_set(ProcessCommandLine, 10),
    LastSeenBefore = max(TimeGenerated)
by AccountName;

// Main Detection: Current certutil activity
let CertutilActivity = DeviceProcessEvents
| where TimeGenerated >= ago(DetectionWindow)
| where FileName =~ CertutilBinary
| extend
    CommandLine = ProcessCommandLine,
    CommandLineLower = tolower(ProcessCommandLine),
    ExecPath = FolderPath,
    ExecPathLower = tolower(FolderPath),
    ParentProcess = InitiatingProcessFileName,
    ParentCommandLine = InitiatingProcessCommandLine,
    Account = AccountName,
    Domain = AccountDomain
| extend
    // Detection flags
    HasMaliciousFlags = CommandLineLower has_any (MaliciousFlags),
    HasSuspiciousPatterns = CommandLineLower has_any (SuspiciousPatterns),
    IsLegitimateOperation = CommandLineLower has_any (LegitimateOperations),
    IsFromSuspiciousPath = ExecPathLower has_any (SuspiciousPaths),
    
    // Extract specific indicators
    HasURLCache = CommandLineLower has "-urlcache",
    HasEncodeDecode = CommandLineLower has "-encode" or CommandLineLower has "-decode",
    HasNetworkURL = CommandLineLower matches regex @"https?://[^\s]+",
    
    // Extract URL if present
    ExtractedURL = extract(@"(https?://[^\s]+)", 1, CommandLine),
    
    // Parent process risk
    IsSuspiciousParent = ParentProcess in~ ("cmd.exe", "powershell.exe", "wscript.exe", "cscript.exe", "mshta.exe"),
    
    // Timing
    IsOffHours = hourofday(TimeGenerated) not between (7 .. 18);

// Join with baseline
CertutilActivity
| join kind=leftouter (CertutilBaseline) on $left.Account == $right.AccountName
| extend
    HasBaseline = isnotnull(BaselineExecutions),
    IsNewUser = isnull(BaselineExecutions) or BaselineExecutions < 2,
    IsNewPath = not(KnownPaths has ExecPathLower),
    DaysSinceLastSeen = datetime_diff('day', TimeGenerated, LastSeenBefore),
    FrequencyAnomaly = iif(BaselineExecutions > 0, 
        todouble(1) / BaselineExecutions * 100, 
        100.0)  // New user = 100% anomaly

// Filter to suspicious activity only
| where HasMaliciousFlags or (HasSuspiciousPatterns and not(IsLegitimateOperation))

// Enhanced Risk Scoring
| extend
    // Base operation risk
    OperationRisk = case(
        HasURLCache and HasNetworkURL, 40,           // Downloading from URL (classic attack)
        HasEncodeDecode and HasNetworkURL, 35,       // Encoding/decoding with network activity
        HasURLCache, 30,                             // URL cache without visible URL (may be obfuscated)
        HasEncodeDecode, 25,                         // Encoding/decoding files
        HasMaliciousFlags, 20,                       // Other malicious flags
        10
    ),
    
    // Context risk
    ContextRisk = case(
        IsFromSuspiciousPath and IsSuspiciousParent, 25,  // Suspicious path + parent
        IsFromSuspiciousPath, 20,                         // Suspicious execution location
        IsSuspiciousParent, 15,                           // Suspicious parent process
        10
    ),
    
    // Behavioral anomaly risk
    AnomalyRisk = case(
        IsNewUser, 20,                               // Never seen this user with certutil
        IsNewPath and HasBaseline, 15,               // New execution path for known user
        FrequencyAnomaly > 90, 10,                   // Very rare usage
        DaysSinceLastSeen > 180, 10,                 // Not seen in 6+ months
        5
    ),
    
    // Additional indicators
    IndicatorRisk = case(
        IsOffHours, 10,                              // Off-hours execution
        5
    ),
    
    TotalRiskScore = OperationRisk + ContextRisk + AnomalyRisk + IndicatorRisk

| extend
    AlertSeverity = case(
        TotalRiskScore >= 75, "High",
        TotalRiskScore >= 60, "Medium",
        "Low"
    )

// Filter to actionable alerts
| where AlertSeverity in ("High", "Medium")

| extend
    Evidence = pack(
        "CommandLine", CommandLine,
        "ExecutionPath", ExecPath,
        "ParentProcess", ParentProcess,
        "ParentCommandLine", ParentCommandLine,
        "ExtractedURL", ExtractedURL,
        "MaliciousFlags", extract_all(@"-(\w+)", CommandLine),
        "IsFromSuspiciousPath", IsFromSuspiciousPath,
        "IsNewPath", IsNewPath,
        "IsNewUser", IsNewUser,
        "BaselineExecutions", coalesce(BaselineExecutions, 0),
        "DaysSinceLastSeen", DaysSinceLastSeen
    ),
    
    ThreatContext = pack(
        "AttackType", case(
            HasURLCache and HasNetworkURL, "File Download via Certutil",
            HasEncodeDecode, "File Encoding/Obfuscation",
            "Certutil LOLBAS Abuse"
        ),
        "CommonUsage", case(
            HasURLCache, "Download malicious payload or tools",
            HasEncodeDecode, "Obfuscate malware or exfiltrate data",
            "Reconnaissance or staging"
        ),
        "RiskFactors", strcat_array(
            dynamic([
                iff(HasNetworkURL, "Network Download", ""),
                iff(IsFromSuspiciousPath, "Suspicious Path", ""),
                iff(IsSuspiciousParent, "Suspicious Parent", ""),
                iff(IsNewUser, "New User", ""),
                iff(IsOffHours, "Off-Hours", "")
            ]) | where strlen(tostring($0)) > 0,
            ", "
        )
    ),
    
    Recommendations = case(
        AlertSeverity == "High",
        "IMMEDIATE: 1) Isolate device 2) If URL present, analyze downloaded file 3) Check parent process legitimacy 4) Hunt for persistence mechanisms 5) Review account for compromise indicators 6) Block extracted URL at network perimeter",
        AlertSeverity == "Medium",
        "INVESTIGATE: 1) Validate user authorization for this activity 2) If URL present, analyze destination 3) Check for encoded/decoded files 4) Review command justification 5) Consider blocking certutil via AppLocker/WDAC if not required",
        "MONITOR: Document for baseline improvement"
    ),
    
    DetectedTechniques = strcat_array(
        dynamic([
            "T1105 (Ingress Tool Transfer)",
            iff(HasEncodeDecode, "T1027 (Obfuscated Files or Information)", ""),
            iff(HasURLCache, "T1218 (System Binary Proxy Execution)", ""),
            "T1140 (Deobfuscate/Decode Files or Information)"
        ]) | where strlen(tostring($0)) > 0,
        ", "
    ),
    
    IOCs = pack(
        "URLs", iff(isnotempty(ExtractedURL), dynamic([ExtractedURL]), dynamic([])),
        "SuspiciousPath", ExecPath,
        "CommandPattern", CommandLine
    )

| project
    TimeGenerated,
    DeviceName,
    AlertSeverity,
    TotalRiskScore,
    Account = strcat(Domain, "\\", Account),
    CommandLine,
    ExecutionPath = ExecPath,
    ExtractedURL,
    ParentProcess,
    ThreatContext,
    Evidence,
    IOCs,
    DetectedTechniques,
    Recommendations

| sort by TotalRiskScore desc, TimeGenerated desc
